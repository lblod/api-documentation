<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>node_modules/@lblod/ember-contenteditable-editor/addon/utils/editor/select.js - editor-documentation</title>
    <meta name="description" content="LBLOD editor Documentation pages">
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="stylesheet" href="../assets/css/custom.css">
    <link rel="stylesheet" href="../assets/vendor/bootstrap/css/bootstrap.css">
    <link rel="stylesheet" href="../assets/vendor/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="../assets/css/theme.css">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,500,600,700' rel='stylesheet' type='text/css'>
    

</head>
<body>
    <nav class="navbar navbar-default">
      <div class="container-fluid">
        <div class="navbar-header">
          <a href="../" class="navbar-brand">
              <img src="../assets/img/ember-logo.png" alt="enterprise logo">
            <span>editor-documentation</span>
          </a>
        </div>

        <div class="collapse navbar-collapse" id="nav">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="" class="fa fa-github github"></a></li>
          </ul>
        </div>
      </div>
    </nav>
    <div id="main-wrapper" class="row">
        <div id="content-wrapper">
            <ol class="panel-group" id="sidebar" role="tablist" aria-multiselectable="true">
                <li class="panel panel-default">
                    <div class="panel-heading" role="tab" id="sidebar-search-heading">
                        <h4 class="panel-title">
                      <a role="button" data-toggle="collapse" href="#sidebar-search" aria-expanded="true" aria-controls="collapseOne">
                        Search
                      </a>
                    </h4>
                    </div>
                    <div id="sidebar-search" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="sidebar-search-heading">
                        <div class="panel-body">
                            <div id="api-tabview-filter">
                                <input type="search" id="api-filter" placeholder="Search...">
                            </div>
                        </div>
                    </div>
                </li>
                    <li class="panel panel-default">
                        <div class="panel-heading" role="tab" id="sidebar-version-heading">
                            <h4 class="panel-title">
                                <a role="button" href="/commits/2bbb5b15" target="_blank">
                                  Tag: 0.0.0.2bbb5b15
                                </a>
                            </h4>
                        </div>
                    </li>
                <li class="panel panel-default">
                    <div class="panel-heading" role="tab" id="sidebar-modules-heading">
                        <h4 class="panel-title">
                    <a role="button" data-toggle="collapse" href="#sidebar-modules" aria-expanded="true" aria-controls="collapseOne">
                      Modules
                    </a>
                  </h4>
                    </div>
                    <div id="sidebar-modules" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="sidebar-modules-heading">
                        <div class="panel-body">
                                <ol>
                                        <li>
                                            <a href="../modules/contenteditable-editor.html">contenteditable-editor</a>
                                        </li>
                                        <li>
                                            <a href="../modules/editor-core.html">editor-core</a>
                                        </li>
                                        <li>
                                            <a href="../modules/pernetApi.html">pernetApi</a>
                                        </li>
                                        <li>
                                            <a href="../modules/rdfa-editor.html">rdfa-editor</a>
                                        </li>
                                </ol>
                        </div>
                    </div>
                </li>
            
                <li class="panel panel-default">
                    <div class="panel-heading" role="tab" id="sidebar-classes-heading">
                        <h4 class="panel-title">
                      <a role="button" data-toggle="collapse" href="#sidebar-classes" aria-expanded="true" aria-controls="collapseOne">
                        Classes
                      </a>
                    </h4>
                    </div>
                    <div id="sidebar-classes" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="sidebar-classes-heading">
                        <div class="panel-body">
                            <ol>
                                    <li>
                                        <a href="../classes/ArrowHandler.html">ArrowHandler</a>
                                    </li>
                                    <li>
                                        <a href="../classes/BackspaceHandler.html">BackspaceHandler</a>
                                    </li>
                                    <li>
                                        <a href="../classes/BoldProperty.html">BoldProperty</a>
                                    </li>
                                    <li>
                                        <a href="../classes/CappedHistory.html">CappedHistory</a>
                                    </li>
                                    <li>
                                        <a href="../classes/ContentEditableComponent.html">ContentEditableComponent</a>
                                    </li>
                                    <li>
                                        <a href="../classes/DocumentStructureComponent.html">DocumentStructureComponent</a>
                                    </li>
                                    <li>
                                        <a href="../classes/DomHelpers.html">DomHelpers</a>
                                    </li>
                                    <li>
                                        <a href="../classes/EditorProperty.html">EditorProperty</a>
                                    </li>
                                    <li>
                                        <a href="../classes/EmphasisMarkdownHandler.html">EmphasisMarkdownHandler</a>
                                    </li>
                                    <li>
                                        <a href="../classes/EnterHandler.html">EnterHandler</a>
                                    </li>
                                    <li>
                                        <a href="../classes/EventProcessor.html">EventProcessor</a>
                                    </li>
                                    <li>
                                        <a href="../classes/HandlerResponse.html">HandlerResponse</a>
                                    </li>
                                    <li>
                                        <a href="../classes/HeaderMarkdownHandler.html">HeaderMarkdownHandler</a>
                                    </li>
                                    <li>
                                        <a href="../classes/HintsRegistry.html">HintsRegistry</a>
                                    </li>
                                    <li>
                                        <a href="../classes/HintsRegistryDebugger.html">HintsRegistryDebugger</a>
                                    </li>
                                    <li>
                                        <a href="../classes/IgnoreModifiersHandler.html">IgnoreModifiersHandler</a>
                                    </li>
                                    <li>
                                        <a href="../classes/ItalicProperty.html">ItalicProperty</a>
                                    </li>
                                    <li>
                                        <a href="../classes/ListInsertionMarkdownHandler.html">ListInsertionMarkdownHandler</a>
                                    </li>
                                    <li>
                                        <a href="../classes/NodeWalker.html">NodeWalker</a>
                                    </li>
                                    <li>
                                        <a href="../classes/RawEditor.html">RawEditor</a>
                                    </li>
                                    <li>
                                        <a href="../classes/RdfaBackspaceHandler.html">RdfaBackspaceHandler</a>
                                    </li>
                                    <li>
                                        <a href="../classes/RdfaBlock.html">RdfaBlock</a>
                                    </li>
                                    <li>
                                        <a href="../classes/RdfaContextDebugger.html">RdfaContextDebugger</a>
                                    </li>
                                    <li>
                                        <a href="../classes/RdfaContextScanner.html">RdfaContextScanner</a>
                                    </li>
                                    <li>
                                        <a href="../classes/RdfaEditorComponent.html">RdfaEditorComponent</a>
                                    </li>
                                    <li>
                                        <a href="../classes/RdfaEditorDebugger.html">RdfaEditorDebugger</a>
                                    </li>
                                    <li>
                                        <a href="../classes/RdfaEditorDispatcher.html">RdfaEditorDispatcher</a>
                                    </li>
                                    <li>
                                        <a href="../classes/RdfaEditorLoadMonitor.html">RdfaEditorLoadMonitor</a>
                                    </li>
                                    <li>
                                        <a href="../classes/RdfaEditorSuggestedHintsComponent.html">RdfaEditorSuggestedHintsComponent</a>
                                    </li>
                                    <li>
                                        <a href="../classes/RdfaEditorToolbarComponent.html">RdfaEditorToolbarComponent</a>
                                    </li>
                                    <li>
                                        <a href="../classes/RichNode.html">RichNode</a>
                                    </li>
                                    <li>
                                        <a href="../classes/TextInputHandler.html">TextInputHandler</a>
                                    </li>
                                    <li>
                                        <a href="../classes/UnderlineProperty.html">UnderlineProperty</a>
                                    </li>
                            </ol>
                        </div>
                    </div>
                </li>
            </ol>
            <div class="content-container">
                <div class="apidocs">
                    <div id="docs-main">
                        <div class="content">
<div class="page-header">
    <h1><i class="fa fa-file-code-o" aria-hidden="true"></i>  File</h1>
</div>

<div class="file">
    <pre class="prettyprint linenums">
import { positionInRange } from &#x27;@lblod/marawa/range-helpers&#x27;;
import { analyse as scanContexts } from &#x27;@lblod/marawa/rdfa-context-scanner&#x27;;

/**
 * SELECTION API RESULT
 *
 * This is an internal API.  It is subject to change.
 *
 * The idea of the selection API is that it yields the nodes on
 * which changes need to occur with their respective ranges.  This
 * means that we may return more than one node and that each of the
 * nodes might only have a sub-range selected on them.  We also need
 * to share sufficient information on the intention of the user, so
 * we can manipulate the contents correctly.
 *
 * The resulting entity has a top-level object which describes the
 * intention of the user.  Further elements of the selection contain
 * the effectively selected blobs on which we expect the user to
 * operate.
 *
 * @param {boolean} selectedHighlightRange Truethy iff the plugin
 *   selected a portion of the highlight, rather than a contextual
 *   element.
 * @param {[Selection]} selections A matched selection containing
 *   both the tag to which the change should be applied, as well as
 *   the RichNode of the change.
 * @param {[Number]} selections.range Range which should be
 *   highlighted.  Described by start and end.
 * @param {RichNode} selections.richNode Rich Node to which the
 *   selection applies.
 */

/**
 * Selects the current selection, for applying operations to.
 * Current selection may be a cursor or a range.
*/
function selectCurrentSelection() {
  return selectHighlight.bind(this)(this.currentSelection);
}

/**
 * Selects the highlighted range, or part of it, for applying
 * operations to.
 *
 * With no arguments, this method selects the full highlighted range
 * in order to apply operations to it.  The options hash can be used
 * to supply constraints:
 *
 * - { offset } : Array containing the left offset and right offset.
 *   Both need to be positive numbers.  The former is the amount of
 *   characters to strip off the left, the latter the amount of
 *   characters to strip off the right.
 * - TODO { regex } : Regular expression to run against the matching
 *   string.  Full matching string is used for manipulation.
 */
function selectHighlight([start,end], options = {}) {

  if( options.offset ) {
    start += options.offset[0] || 0;
    end -= options.offset[1] || 0;
  }
  if( start &gt; end ) {
    throw new Error(&#x60;Selection ${start}, ${end} with applied offset of ${options.offset} gives an index in which start of region is not before or at the end of the region&#x60;);
  }

  const selections = [];
  let nextWalkedNodes = [this.richNode];

  while( nextWalkedNodes.length ) {
    let currentNodes = nextWalkedNodes;
    nextWalkedNodes = [];
    for( let node of currentNodes ){
      if( !node.children ) {
        if (positionInRange(node.start, [start, end]) || positionInRange(node.end, [start,end])
            || positionInRange(start, node.region) || positionInRange(end, node.region) ) {
          // handle lowest level node
          if (node.region[1] &gt; end &amp;&amp; node.type === &#x27;tag&#x27;) {
            console.debug(&#x27;dropping tag&#x27;, node); // eslint-disable-line no-console
          }
          else {
            selections.push( {
              richNode: node,
              range: [ Math.max( node.start, start ), Math.min( node.end, end ) ] } );
          }
        }
        else {
          // do nothing, it&#x27;s not overlapping
        }
      }
      else {
        if (positionInRange(start, node.region) || positionInRange(end, node.region) || positionInRange(node.start, [start,end]) || positionInRange(node.end, [start,end]))
          node.children.forEach( (child) =&gt; nextWalkedNodes.push( child ) );
      }
    }
  }

  return {
    selectedHighlightRange: [start, end],
    selections: selections
  };
}

/**
 * Selects nodes based on an RDFa context that should be applied.
 *
 * Options for scope search default to &#x27;auto&#x27;.
 *
 * Options for filtering:
 * - range: The range object describing the highlighted region.
 * - scope:
 *   - &#x27;outer&#x27;: Search from inner range and search for an item
 spanning the full supplied range or more.
 *   - &#x27;inner&#x27;: Search from outer range and search for an item which
 is fully contained in the supplied range.
 *   - &#x27;auto&#x27;: Perform a best effort to find the nodes in which you&#x27;re
 interested.
 * - property: string of URI or array of URIs containing the property (or properties) which must apply.
 * - typeof: string of URI or array of URIs containing the types which must apply.
 * - datatype: string of URI containing the datatype which must apply.
 * - resource: string of URI containing the resource which must apply.
 * - TODO content: string or regular expression of RDFa content.
 * - TODO attribute: string or regular expression of attribute available on the node.
 */
function selectContext([start,end], options = {}) {
  if ( !options.scope ) {
    options.scope = &#x27;auto&#x27;;
  }

  if ( ![&#x27;outer&#x27;, &#x27;inner&#x27;, &#x27;auto&#x27;].includes(options.scope) ) {
    throw new Error(&#x60;Scope must be one of &#x27;outer&#x27;, &#x27;inner&#x27; or &#x27;auto&#x27; but is &#x27;${options.scope}&#x27;&#x60;);
  }

  if ( start &gt; end ) {
    throw new Error(&#x60;Selection ${start}, ${end} gives an index in which start of region is not before or at the end of the region&#x60;);
  }

  const filter = {};
  singleFilterKeywords.forEach( key =&gt; filter[key] = options[key] );
  // Make an array of all filter criteria that support arrays
  listFilterKeywords.forEach( key =&gt; filter[key] = options[key] ? [ options[key] ].flat() : [] );

  let rdfaBlocks = scanContexts( this.rootNode, [start, end] );

  let selections = [];

  if ( rdfaBlocks.length == 0 )
    return selections;

  let foundInnerMatch = false;

  if ( options.scope == &#x27;inner&#x27; || options.scope == &#x27;auto&#x27; ) {
    selections = filterInner(rdfaBlocks, filter, [start, end]);
    foundInnerMatch = selections.length &gt; 0;
  }

  if ( options.scope == &#x27;outer&#x27; || ( options.scope == &#x27;auto&#x27; &amp;&amp; !foundInnerMatch ) ) {
    selections = filterOuter(rdfaBlocks, filter, [start, end]);
  }

  return { selections };
}

// HELPERS

/**
 * List of keywords to filter contexts on that can only contain a single value
*/
const singleFilterKeywords = [&#x27;resource&#x27;, &#x27;datatype&#x27;];

/**
 * List of keywords to filter contexts on that can be either a single value or an array
*/
const listFilterKeywords = [&#x27;typeof&#x27;, &#x27;property&#x27;];

/**
 * Validates if the RDFa attributes of a node matches a specifc set of keys
*/
function isMatchingRdfaAttribute(rdfaAttributes, filter, keys) {
  const isMatchingValue = function(rdfaAttributes, key, value) {
    if ( listFilterKeywords.includes(key) ) {
      return value.reduce( (isMatch, v) =&gt; isMatch &amp;&amp; (rdfaAttributes[key] || []).includes(v) , true);
    } else {
      if ( key == &#x27;resource&#x27;) {
        return rdfaAttributes[&#x27;resource&#x27;] == value || rdfaAttributes[&#x27;about&#x27;] == value;
      } else {
        return rdfaAttributes[key] == value;
      }
    }
  };

  const nonEmptyKeys = keys.filter( key =&gt; filter[key] &amp;&amp; filter[key].length );
  return nonEmptyKeys.reduce( (isMatch, key) =&gt; isMatch &amp;&amp; isMatchingValue(rdfaAttributes, key, filter[key]), true);
}

/**
* Validates if the RDFa context a block matches all filter criteria
* In case a criteria has multiple values, all values must appear on the same node
*     (TODO context scanner currently only supports multi-value on typeof)
* In case resource and type are defined, they must appear on the same node
* In case property and datatype are defined, they must appear on the same node
* In case resource/typeof and property are defined, property must appear as inner context
*   of the typeof/resource node without any other typeof/resource being defined in between
*/
function isMatchingContext(block, filter) {
  // Validates if the scope in which a given property appears matches the resource/typeof filter criteria
  // The function assumes the context that is passed is retrieved from the semantic node that contains the given
  // property as an RDFa attribute. Therefore we start walking the context array from end to start to find
  // the triple matching the given property.
  const isMatchingScopeForProperty = function(context, property, resource, types) {
    let i = context.length;
    let matchingTriple = null;

    while ( !matchingTriple &amp;&amp; i &gt; 0 ) {
      i--;
      if ( context[i].predicate == property )
        matchingTriple = context[i];
    }

    const subject = matchingTriple.subject;
    if (resource &amp;&amp; subject != resource)
      return false;

    if ( types.length ) {
      const typesOfSubject = context.filter(t =&gt; t.subject == subject &amp;&amp; t.predicate == &#x27;a&#x27;).map(t =&gt; t.object);
      const matchesAllTypes = types.reduce( (isMatch, t) =&gt; isMatch &amp;&amp; typesOfSubject.includes(t) , true);
      if ( !matchesAllTypes )
        return false;
    }

    return true;
  };


  if ( filter.property.length || filter.datatype ) {
    let isMatch = isMatchingRdfaAttribute(block.semanticNode.rdfaAttributes, filter, [&#x27;property&#x27;, &#x27;datatype&#x27;]);

    if ( isMatch &amp;&amp; (filter.resource || filter.typeof.length) ) {
      // we already know the properties match and appear on the same node
      // Hence, they all have the same subject and it&#x27;s sufficient to only pass the first property
      return isMatchingScopeForProperty(block.context, filter.property[0], filter.resource, filter.typeof);
    }

    return isMatch;
  } else if ( filter.resource || filter.typeof.length ) {
    return isMatchingRdfaAttribute(block.semanticNode.rdfaAttributes, filter, [&#x27;resource&#x27;, &#x27;typeof&#x27;]);
  }

  return false; // no filter criteria defined?
}

/**
* Find rich nodes that strictly fall inside the requested range and match the filter criteria
*
* We will go over the list of RDFa blocks that strictly fall inside the request range and check whether they
* match the requested filter criteria. There is no need to start walking the tree of rich nodes attached to
* the semanticNode because other RDFa contexts will be represented by another RDFa block in the initial list of blocks.
* In case 2 matching semantic nodes are nested only the highest (ancestor) node is returned.
*/
function filterInner(blocks, filter, [start, end]) {
  // Add a selection to the list, but only keep selections for the highest nodes in the tree
  const updateSelections = function(selections, newSelection) {
    const isChildOfExistingSelection = selections.find( selection =&gt; selection.richNode.isAncestorOf(newSelection.richNode) );

    if ( !isChildOfExistingSelection ) {
      const updatedSelections = selections.filter( selection =&gt; !selection.richNode.isDescendentOf(newSelection.richNode) );
      updatedSelections.push(newSelection);
      return updatedSelections;
    } else { // the newSelection is a child of an existing selection. Nothing should happen.
      return selections;
    }
  };

  let selections = [];

  blocks
    .filter(block =&gt; block.semanticNode.rdfaAttributes)
    .filter(block =&gt; block.semanticNode.isInRegion(start, end))
    .forEach( function(block) {
      if ( isMatchingContext(block, filter) ) {
        const selection = {
          richNode: block.semanticNode,
          range: block.semanticNode.region,
          context: block.context
        };
        selections = updateSelections( selections, selection);
      }
    });

  return selections;
}

/**
* Find rich nodes that strictly contain the requested range and match the filter criteria
*
* We will go over the list of RDFa blocks that strictly contain the request range and check whether they
* match the requested filter criteria. There is no need to start walking the tree of rich nodes attached to
* the semanticNode because other RDFa contexts will be represented by another RDFa block in the initial list of blocks.
* In case 2 matching semantic nodes are nested only the lowest (child) node is returned.
*/
function filterOuter(blocks, filter, [start, end]) {
  // Add a selection to the list, but only keep selections for the lowest nodes in the tree
  const updateSelections = function(selections, newSelection) {
    const isAncestorOfExistingSelection = selections.find( selection =&gt; selection.richNode.isDescendentOf(newSelection.richNode) );

    if ( !isAncestorOfExistingSelection ) {
      const updatedSelections = selections.filter( selection =&gt; !selection.richNode.isAncestorOf(newSelection.richNode) );
      updatedSelections.push(newSelection);
      return updatedSelections;
    } else { // the newSelection is an ancestor of an existing selection. Nothing should happen.
      return selections;
    }
  };

  let selections = [];

  blocks
    .filter(block =&gt; block.semanticNode.rdfaAttributes)
    .filter(block =&gt; block.semanticNode.containsRegion(start, end))
    .forEach( function(block) {
      if ( isMatchingContext(block, filter) ) {
        const selection = {
          richNode: block.semanticNode,
          range: block.semanticNode.region,
          context: block.context
        };
        selections = updateSelections(selections, selection);
      }
    });

  return selections;
}

export {
  selectCurrentSelection,
  selectHighlight,
  selectContext
}

    </pre>
</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="../assets/vendor/prettify/prettify-min.js"></script>
    <script>prettyPrint();</script>
    <script src="../assets/vendor/jquery/jquery.min.js"></script>
    <script src="../assets/vendor/jquery-ui/jquery-ui.min.js"></script>
    <script src="../assets/vendor/bootstrap/js/bootstrap.js"></script>
    <script src="../assets/vendor/github-slugger/slugger.js"></script>
    <script src="../assets/js/yuidoc-bootstrap.js"></script>
</body>
</html>
